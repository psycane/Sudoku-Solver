var shared_numbers={},shared_errors={},shared_collections={},shared_html={},shared_selection={},shared_strings={},shared_http={},shared_location={},shared_requests={},recommendation_recommendation={},text_text={},shared_state={},shared_storage={},shared_templates={},shared_messaging={},config_config={},shared_events={},shared_component={},recommendation_journey_recommendation_journey={},minimised_minimised={},shared_forms={},email_journey_email={},safari_journey_safari={},shared_scroll={},shared_functions={},popup_popup={},application_application={},iframe_host={},entry_point_launcher={},entry_point_entry_point={};shared_numbers=function(t){function e(t,e){return Math.floor(Math.random()*(e-t+1))+t}return t.randomInteger=e,t}(shared_numbers);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};shared_errors=function(t){var e=function(){function t(){}return t.unhandled=function(t){r.log(t)},t.capture=function(e){return function(){try{e()}catch(e){t.unhandled(e)}}},t}();t.UnhandledError=e;var n=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(Error);t.NoSuchElement=n;var r=function(){function t(){}return t.log=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];t.enabled&&console.log(e,n)},t.enabled=!1,t}();return t.Debug=r,t}(shared_errors);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};shared_collections=function(t,e,n){function r(t){for(var n=t.length-1;n>0;n--){var r=e.randomInteger(0,n),o=t[n];t[n]=t[r],t[r]=o}return t}function o(t){var e=new i;if(!t)return e;for(var n=0;n<t.length;++n)e.push(t[n]);return e}t.shuffle=r;var i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.each=function(t){for(var e=0;e<this.length;++e)t(this[e],e);return this},e.prototype.map=function(t){var n=new e;return this.each(function(e,r){n.push(t(e,r))}),n},e.prototype.flatMap=function(t,n){return void 0===n&&(n=new e),this.each(function(e,r){var o=t(e,r);Array.prototype.push.apply(n,o)}),n},e.prototype.filter=function(t){var n=new e;return this.each(function(e,r){t(e)&&n.push(e)}),n},e.prototype.find=function(t){return this.filter(t).head()},e.prototype.as=function(t){var e=this;return e.filter(function(e){return e instanceof t})},e.prototype.head=function(){return this[0]},e.prototype.last=function(){if(this.isEmpty())throw new n.NoSuchElement;return this[this.length-1]},e.prototype.isEmpty=function(){return 0==this.length},e.prototype.groupBy=function(t){return this.reduce(function(n,r){var o=t instanceof Function?t(r):r[t];return(n[o]=n[o]||new e).push(r),n},{})},e}(Array);return t.List=i,t.list=o,t}(shared_collections,shared_numbers,shared_errors),shared_html=function(t,e){function n(t,e){for(var n=o(e),r=0;r<n.length;r++){var i=n[r];t.appendChild(i)}return t}function r(t){return void 0!==t.outerHTML}function o(t){var e=document.createElement("div");return e.innerHTML=r(t)?t.outerHTML:t,e.childNodes}function i(t,e){for(var n=t.parentNode,r=o(e),i=0;i<r.length;i++){var s=r[i];n.insertBefore(s,t)}return t}function s(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return function(e){for(var n=0;n<t.length;n++){var r=t[n];Object.keys(r).forEach(function(t){var n=r[t],o=typeof n;switch(o){case"function":e.setAttribute(t,n(e.getAttribute(t)));break;case"boolean":n?e.setAttribute(t,""):e.removeAttribute(t);break;default:e.setAttribute(t,String(n))}})}return e}}function a(t,e,n,r){"string"==typeof e&&(e=[e]);for(var o=0;o<e.length;o++){var i=e[o];t.addEventListener(i,function(t){var e=n(t);e||(t.preventDefault(),t.stopPropagation())},r)}}function c(){return"BackCompat"==document.compatMode?document.body:document.documentElement}function u(t){return void 0===t&&(t=c()),t.scrollHeight>t.clientHeight}function h(t){return void 0===t&&(t=c()),t.scrollWidth>t.clientWidth}var l=function(){function t(){}return t.path=function(t){for(var n=new e.List;t;)n.push(t),t=t.parentElement;return n},t.matches=function(t,e){return t.matches=t.matches||t.msMatchesSelector||function(t){return!1},t.matches(e)},t}();return t.Elements=l,t.appendHtml=n,t.isHTML=r,t.parseHtml=o,t.insertHtml=i,t.attributes=s,t.on=a,t.root=c,t.hasVerticalScrollBar=u,t.hasHorizontalScrollBar=h,t}(shared_html,shared_collections);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};shared_selection=function(t,e,n){function r(t,e){function n(e,n){for(var r=n.querySelectorAll(t),o=0;o<r.length;++o)e.push(r[o]);return e}void 0===e&&(e=document);var r=new i;if("string"!=typeof t)return r.push(t),r;if(e instanceof i){for(var o=0;o<e.length;o++){var s=e[o];n(r,s)}return r}return n(r,e)}function o(t,e){return e.querySelector(t)}var i=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.prototype.on=function(t,e,r){return this.each(function(o){n.on(o,t,function(t){return e(o,t)},r)})},r.prototype.attr=function(t,e){return null==e?this.map(function(e){return e.getAttribute(t)}):this.each(function(n){n.setAttribute(t,e)})},r.prototype.removeAttr=function(t){return this.each(function(e){e.removeAttribute(t)})},r.prototype.prop=function(t,e){return null==e?this.map(function(e){return e[t]}):this.each(function(n){n[t]=e})},r.prototype.text=function(t){return null==t?this.map(function(t){return t.textContent}):this.each(function(e){e.textContent=t})},r.prototype.html=function(t){return null==t?this.map(function(t){return t.innerHTML}):this.each(function(e){e.innerHTML=t})},r.prototype.css=function(t,e){return null==e?this.map(function(e){return window.getComputedStyle(e).getPropertyValue(t)}):this.each(function(n){n.style[t]=e})},r.prototype.append=function(t){return this.map(function(e){return n.appendHtml(e,t)}),this},r.prototype.appendTo=function(t){return this.each(function(e){t.appendChild(e)})},r.prototype.insert=function(t){return this.map(function(e){return n.insertHtml(e,t)}),this},r.prototype.remove=function(t){return void 0===t&&(t=function(t){return!0}),this.each(function(e){t&&e.parentNode.removeChild(e)})},r.prototype.children=function(){return this.flatMap(function(t){return e.list(t.childNodes)},new r)},r.prototype.detach=function(){var t=document.createDocumentFragment();return this.each(function(e){t.appendChild(e)}),t},r.prototype.clone=function(){var t=document.createDocumentFragment();return this.each(function(e){t.appendChild(e.cloneNode(!0))}),t},r.prototype.show=function(){return this.each(function(t){t.style.display=""})},r.prototype.hide=function(){return this.each(function(t){t.style.display="none"})},r.prototype.addClass=function(t){return this.each(function(e){e.classList.add(t)})},r.prototype.removeClass=function(t){return this.each(function(e){e.classList.remove(t)})},r}(e.List);return t.Select=i,t.select=r,t.get=o,t}(shared_selection,shared_collections,shared_html),shared_strings=function(t){function e(t){return null==t||""==t}function n(t){if(void 0==t)return null;try{return JSON.parse(t)}catch(e){return t}}function r(t,e){return 0==e.indexOf(t)}return t.isEmpty=e,t.coerce=n,t.startsWith=r,t}(shared_strings),shared_http=function(t,e,n){function r(n,r){if(void 0===r&&(r=t.fireAndForget),JSON.stringify(n)==JSON.stringify(c))return e.Debug.log("duplicate request",n,c),function(){};c=n;var o=new XMLHttpRequest;o.open(n.method,n.url,!0),o.withCredentials=!0;var i=n.headers||{};return Object.keys(i).forEach(function(t){o.setRequestHeader(t,i[t])}),o.addEventListener("readystatechange",e.UnhandledError.capture(function(){if(4==o.readyState){var t=o.getAllResponseHeaders().split("\n").reduce(function(t,e){var n=e.split(": ");return t[n[0]]=n[1],t},{});r({status:o.status,headers:t,entity:new a(o.responseText)})}})),o.send(n.entity),function(){o.abort()}}function o(t){var e=document.createElement("a");return e.href=t,{scheme:e.protocol?e.protocol.replace(/(:$)/,""):"",host:e.hostname,authority:e.host,path:e.pathname,query:e.search?e.search.replace(/(^\?)/,""):"",fragment:e.hash?e.hash.replace(/(^#)/,""):""}}function i(t){void 0===t&&(t=document.location.href);var e=o(t).query;return""==e?{}:e.split("&").map(function(t){return t.split("=")}).reduce(function(t,e){var r=e[0],o=n.coerce(e[1]),i=t[r];return"undefined"==typeof i?t[r]=o:"object"==typeof i?i.push(o):t[r]=[i,o],t},{})}function s(t){var e=[];return Object.keys(t).forEach(function(n){var r=t[n];null==r?e.push(encodeURIComponent(n)):"object"==typeof r?r.forEach(function(t){e.push(encodeURIComponent(n)+"="+encodeURIComponent(t))}):e.push(encodeURIComponent(n)+"="+encodeURIComponent(r))}),e.join("&")}var a=function(){function t(t){this.content=t}return t.prototype.xml=function(){return(new DOMParser).parseFromString(this.content,"application/xml")},t.prototype.text=function(){return this.content},t.prototype.json=function(){return JSON.parse(this.content)},t.prototype.html=function(){return(new DOMParser).parseFromString(this.content,"text/html")},t}();t.Entity=a,t.fireAndForget=function(t){};var c={};t.http=r,t.uri=o,t.queryObject=i,t.toQueryString=s;var u=function(){function t(){}return t.baseUrl=function(t){var e={regex:new RegExp("(https?://[^/]+/[^/]+/).*"+t),process:function(t){return t.match(e.regex)[1]}};try{throw new Error}catch(n){try{return e.process(n.stack)}catch(n){return e.process(document.querySelector('script[src$="'+t+'"]').src)}}},t.origin=function(t){var e=document.createElement("a");return e.href=t,e.protocol+"//"+e.host},t}();return t.BaseUrl=u,t}(shared_http,shared_errors,shared_strings),shared_location=function(t,e,n){var r=function(){function t(e,n,r,o,i){void 0===e&&(e=t.extractType()),void 0===n&&(n=t.extractDoi()),void 0===r&&(r=t.extractIssn()),void 0===o&&(o=window.location.href),void 0===i&&(i=t.extractHostsite(o)),this.type=e,this.doi=n,this.issn=r,this.url=o,this.hostsite=i,this.dois=n?[n]:[]}return t.extractHostsite=function(t){var e=n.uri(t).authority;return e.indexOf("nature.com")!=-1?"nature":e.indexOf("springer.com")!=-1?"springer":e.indexOf("biomedcentral.com")!=-1?"biomedcentral":e.indexOf("localhost")!=-1?"localhost":"unknown"},t.prototype.toQuery=function(){return encodeURIComponent(this.json())},t.prototype.json=function(){return JSON.stringify(this)},t.extractType=function(){var n=t.extractDoi();if(n)return"article";var r=e.select("meta[name='citation_article_type'], meta[name='WT.cg_s']").attr("content").head();if(r){var o=r.toLowerCase();"latest research"==o&&(o="research");var i=["article","research","issue"];if(i.indexOf(o)!=-1)return o}return 0==document.title.indexOf("Table of contents")?"issue":null},t.extractDoi=function(){var t=e.select("meta[name='citation_doi'], meta[name='dc.identifier'], meta[name='DC.identifier'], meta[name='prism.doi']").attr("content").head();return null!=t?t.replace("doi:",""):null},t.extractIssn=function(){var t=e.select("meta[name='citation_issn'], meta[name='prism.issn'], meta[name='prism.eIssn']").attr("content").head();if(t)return t.toUpperCase();var n=e.select(".issn, .eissn").text().head(),r=n?n.match(/[a-z0-9]{4}\-[a-z0-9]{4}/i):null;return r?r[0].toUpperCase():null},t}();return t.CurrentLocation=r,t}(shared_location,shared_selection,shared_http),shared_requests=function(t){var e=function(){function t(){}return t.config=function(t,e){return{method:"POST",headers:{Accept:"application/json","Content-Type":"text/plain"},url:t+"user/config",entity:JSON.stringify(e)}},t.postEvent=function(t){return{method:"POST",url:t.config.host+"events/"+encodeURIComponent(t.event.subject)+"_"+encodeURIComponent(t.event.action)+"_"+encodeURIComponent(t.event.object),headers:{"Content-Type":"text/plain"},entity:JSON.stringify(t)}},t.get=function(t){return{method:"GET",url:t}},t.recommendations=function(t){return{method:"POST",headers:{Accept:"application/json","Content-Type":"text/plain"},url:t.config.host+"recommendations",entity:JSON.stringify(t)}},t}();return t.Requests=e,t}(shared_requests),recommendation_recommendation=function(t,e){var n=function(){function t(t){this.element=e.get(".recommendation",t)}return t.prototype.render=function(t){var n=e.get(".link",this.element);n.href=t.link,n.title=t.title;var r=e.get(".title",this.element);r.innerHTML=t.title;for(var o=e.get(".author",this.element),i=[],s=0;s<t.authors.length;s++)o.textContent=t.authors[s],i.push(o.outerHTML);e.get(".authors",this.element).innerHTML=i.join(""),e.get(".journal",this.element).textContent=t.journal;var a=e.get(".year",this.element);if(a.textContent="",t.pubdate){var c=new Date(t.pubdate).getFullYear();0==isNaN(c)&&1970!=c&&(a.textContent=String(c))}},t}();return t.RecommendationRenderer=n,t}(recommendation_recommendation,shared_selection),text_text=function(t,e,n,r){function o(t,e){return i(e)>i(t)}function i(t){return t.offsetHeight+t.offsetTop}var s=function(){function t(){}return t.each=function(t,n,r,o){for(var i,s=function(t){return!e.isEmpty(t)&&o?o(t):null},a=0;null!=(i=n.exec(t));)s(t.substring(a,i.index)),r(i),a=n.lastIndex;s(t.substring(a))},t.replace=function(n,r,o,i){var s=[],a=function(t){return!e.isEmpty(t)&&i?s.push(i(t)):null},c=function(t){return s.push(o(t))};return t.each(n,r,c,a),s.join("")},t}();t.Regex=s;var a=function(){function t(t,e,n,r,o){void 0===t&&(t="word"),void 0===e&&(e="overflowed"),void 0===n&&(n="line-start"),void 0===r&&(r="line-end"),void 0===o&&(o="ellipsis"),this.word=t,this.overflowed=e,this.lineStart=n,this.lineEnd=r,this.ellipsisClass=o}return t.prototype.words=function(t){var e=this;n.list(t.childNodes).forEach(function(n){if(!(n instanceof HTMLSpanElement&&n.classList.contains(e.word)))if(n instanceof Text){var r=document.createDocumentFragment();s.each(n.wholeText,/\s+/g,function(t){r.appendChild(document.createTextNode(t[0]))},function(t){var n=document.createElement("span");n.classList.add(e.word),n.appendChild(document.createTextNode(t)),r.appendChild(n)}),t.replaceChild(r,n)}else e.words(n)})},t.prototype.overflow=function(t){var e=this,n=!1;this.allWords(t).each(function(r){o(t,r)&&(n=!0),n?r.classList.add(e.overflowed):r.classList.remove(e.overflowed)})},t.prototype.allWords=function(t){return r.select("."+this.word,t).as(HTMLElement)},t.prototype.visibleWords=function(t){return r.select("."+this.word+":not(."+this.overflowed+")",t).as(HTMLElement)},t.prototype.lastWord=function(t){return this.visibleWords(t).last()},t.prototype.lines=function(t){var e=this,n=this.visibleWords(t).groupBy(function(t){return t.offsetTop});Object.keys(n).map(function(t){return n[t]}).forEach(function(t){t.each(function(t){return t.classList.remove(e.lineStart,e.lineEnd)}),t.head().classList.add(e.lineStart),t.last().classList.add(e.lineEnd)})},t.prototype.ellipsis=function(t){var e=this;r.select(this.ellipsisClass).each(function(t){t.classList.remove(e.ellipsisClass),t.textContent=t.getAttribute("original-text")});var n=this.lastWord(t);if(this.allWords(t).last()!=n){var i=n.getAttribute("original-text")||n.textContent;n.setAttribute("original-text",i),n.classList.add(this.ellipsisClass);for(var s=i.length;s>0&&(n.textContent=i.substr(0,s)+"â€¦",o(t,n));s--);}},t.prototype.squeeze=function(t,e){var n=this.lastWord(t);n.parentElement.insertBefore(e,n.nextElementSibling),o(t,e)&&(n.classList.add(this.overflowed),this.squeeze(t,e))},t.prototype.process=function(t,e){this.words(t),this.overflow(t),e&&this.squeeze(t,e),this.ellipsis(t),this.lines(t)},t}();return t.StructuredText=a,t.overflowed=o,t.offsetBottom=i,t}(text_text,shared_strings,shared_collections,shared_selection),shared_state=function(t,e,n,r,o,i,s){function a(t,e,n){return void 0===e&&(e=new r.CurrentLocation),void 0===n&&(n=window.screen),l.toUnderscore({config:t,current_location:e,screen:n})}function c(t){return null!=t&&t.constructor==Array}function u(t){return null!=t&&"object"==typeof t}t.state=a;var h=function(){function t(t,e){void 0===e&&(e=new o.ConsoleEventHandler),this.root=t,this.events=e,this.capture(),this.setInitialState()}return t.prototype.capture=function(){var t=this;i.on(this.root,"change",function(e){var n=e.target;return i.Elements.matches(n,".state[name][value]")&&t.setState(n),i.Elements.matches(n,"[data-event-subject][data-event-action][data-event-object]")&&t.trackEvent(n),!0},!0),i.on(this.root,["click","contextmenu"],function(e){var n=o.Events.path(e).find(function(t){return i.Elements.matches(t,":not(.state)[data-event-object]")});return n&&t.trackEvent(n),!0},!0)},t.prototype.setState=function(t){var n=e.get("input[name="+t.name+"]",this.root),r=n.getAttribute("state-new")||n.defaultValue,o=t.value;r!=o&&(n.setAttribute("state-old",r),n.setAttribute("state-new",o))},t.prototype.trackEvent=function(t){var e=this.dataAttributes(t);this.events.fire(encodeURIComponent(t.getAttribute("data-event-subject")),encodeURIComponent(t.getAttribute("data-event-action")),encodeURIComponent(t.getAttribute("data-event-object")),e)},t.prototype.dataAttributes=function(t,e){return void 0===e&&(e={}),s.list(t.attributes).filter(function(t){return n.startsWith("data-",t.name)}).filter(function(t){return!n.startsWith("data-event",t.name)}).reduce(function(t,e){return t[encodeURIComponent(e.name.replace("data-",""))]=e.value,t},e)},t.prototype.setInitialState=function(){var t=this;e.select(".state[name][value]:not([state-new]):checked",this.root).as(HTMLInputElement).each(function(n){var r=e.get("input[name="+n.name+"]",t.root);r.setAttribute("state-new",r.defaultValue)})},t}();t.StateChange=h,t.isArray=c,t.isObject=u;var l=function(){function t(){}return t.toUnderscore=function(t){return this.map(t,function(t){return t.replace(/-/g,"_")})},t.toHyphen=function(t){return this.map(t,function(t){return t.replace(/_/g,"-")})},t.map=function(t,e){var n=this;if(c(t)){var r=t;return r.reduce(function(t,r){return t.push(n.map(r,e)),t},[])}if(u(t)){var o={};for(var i in t){var s=t[i];null!=s&&"function"!=typeof s&&(o[e(i)]=this.map(s,e))}return o}return t},t}();return t.Converter=l,t}(shared_state,shared_selection,shared_strings,shared_location,shared_events,shared_html,shared_collections),shared_storage=function(t,e){function n(t){void 0===t&&(t=window.localStorage);for(var n={},r=0;r<t.length;r++){var o=t.key(r);n[o]=e.coerce(t.getItem(o))}return n}function r(t,n,r){Object.keys(t).forEach(function(o){if(e.startsWith(r,o)){var i=t[o];null==i?n.removeItem(o):n.setItem(o,i)}})}return t.storageObject=n,t.copyIntoStorage=r,t}(shared_storage,shared_strings),shared_templates=function(t,e){var n=function(){function t(){}return t.clone=function(t){return this.polyfill(t),t.ownerDocument.importNode(t.content,!0)},t.polyfill=function(t){t.content||(t.content=e.select(t).children().detach())},t.polyfillTemplates=function(t){var n=this;e.select("template",t).each(function(t){return n.polyfill(t)})},t}();return t.Templates=n,t}(shared_templates,shared_selection),shared_messaging=function(t,e,n,r){var o=function(){function t(){}return t.dispatch=function(t,n){t.dispatchEvent(e.Events.create("client_message",{bubbles:!0,cancelable:!0,detail:n}))},t}();t.MessageDispatcher=o;var i=function(){function t(t,e){var o=this;this.window=t,this.expectedOrigin=e,t.addEventListener("message",function(t){var i=n.uri(t.origin).host,s=n.uri(e).host;if(i!=s)return void r.Debug.log("Origin host did not match expected: expectedHost:"+s+" actualHost:"+i);var a=t.data;r.Debug.log("Message received: "+a.name+" -> "+JSON.stringify(a.body));var c=o[a.name];if(!c)return void r.Debug.log("No slot called "+a.name+" found");try{c.call(o,a.body)}catch(t){r.UnhandledError.unhandled(t)}})}return t}();t.MessageReceiver=i;var s=function(){function t(t,e){this.window=t,this.destinationOrigin=e}return t.prototype.send=function(t,e){this.window.postMessage({name:t,body:e},this.destinationOrigin)},t}();return t.MessageSender=s,t}(shared_messaging,shared_events,shared_http,shared_errors),config_config=function(t,e,n,r,o,i,s,a){var c=function(){function t(n,o){var i=this;this.parent=o,this.storage=window.localStorage,this.parent.config=this,e.copyIntoStorage(s.queryObject(n.current_location.url),this.storage,t.prefix),this.data=t.mergeObjects(n.config,t.extractConfig(e.storageObject(this.storage))),this.render(),r.select("#"+this.id("debug")).on("change",function(t){i.debug(t.checked)}),this.persist("debug",null),this.debug(s.queryObject(n.current_location.url)["uptodate-debug"]===!0)}return t.extractConfig=function(e){var r=this;return Object.keys(e).reduce(function(o,i){if(n.startsWith(r.prefix,i)){var s=i.substr(t.prefix.length);o[s]=e[i]}return o},{})},t.mergeObjects=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];for(var n={},r=function(e){var r=t[e];return null==r?"continue":void Object.keys(r).forEach(function(t){n[t]=r[t]})},o=0;o<t.length;o++)r(o);return n},t.prototype.json=function(){return JSON.stringify(this.data)},t.prototype.render=function(){var t=this;Object.keys(this.data).forEach(function(e){t.createProperty(e,t.data[e])})},t.prototype.createProperty=function(t,e){var i=this.id(t),s=typeof e,a=r.get("#"+i,this.parent);if(a)"boolean"==s?a.checked=e:a.value=String(e);else{var c=r.get("template.config",this.parent),u=o.Templates.clone(c);a=r.get("input",u),"boolean"==s?a.setAttribute("type","checkbox"):"string"==s?a.setAttribute("type","text"):"number"==s&&a.setAttribute("type","number"),a.setAttribute("id",i),"boolean"==s?e?a.setAttribute("checked",""):a.removeAttribute("checked"):a.setAttribute("value",String(e));var h=r.get("label",u);h.setAttribute("for",i);var l=r.get(".text",h);l.textContent=t.replace(/_/g," "),this.parent.insertBefore(u,c.nextSibling)}Object.defineProperty(this.data,t,{enumerable:!0,get:function(){return"boolean"==s?a.checked:n.coerce(a.value)},set:function(t){return"boolean"==s?a.checked=t:a.value=t}})},t.prototype.id=function(e){return t.prefix+e.replace(/_/g,"-")},t.prototype.debug=function(t){a.Debug.enabled=t,this.full_screen(t),t?this.parent.classList.add("debug"):this.parent.classList.remove("debug")},t.prototype.full_screen=function(t){i.MessageDispatcher.dispatch(this.parent,{name:"full_screen",body:t})},t.prototype.persist=function(e,n){var r=t.prefix+e;null==n?this.storage.removeItem(r):this.storage.setItem(r,n)},t.prefix="uptodate-",t}();return t.Config=c,t}(config_config,shared_storage,shared_strings,shared_selection,shared_templates,shared_messaging,shared_http,shared_errors),shared_events=function(t,e,n,r,o,i){var s=function(){function t(){}return t.prototype.fire=function(t,e,n,r){console.log&&console.log("Event: "+t+" "+e+" "+n+" -> "+JSON.stringify(r))},t}();t.ConsoleEventHandler=s;var a=function(){function t(t){this.state=t}return t.prototype.fire=function(t,i,s,a){o.http(r.Requests.postEvent(e.Converter.toUnderscore(n.Config.mergeObjects(this.state,{event:{subject:t,action:i,object:s,data:a}}))))},t.create=function(t,e){if(void 0===e&&(e={bubbles:!0,cancelable:!0,detail:null}),e.detail)try{return new CustomEvent(t,e)}catch(r){var n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n}else try{return new Event(t,e)}catch(n){var r=document.createEvent("Event");return r.initEvent(t,e.bubbles,e.cancelable),r}},t.path=function(t){return i.Elements.path(t.target)},t}();return t.Events=a,t}(shared_events,shared_state,config_config,shared_requests,shared_http,shared_html),shared_component=function(t,e,n,r){var o=function(){function t(t,e){this.root=n.get(t,e)}return t.prototype.fireResize=function(t){var e=6,n=t instanceof HTMLElement?{width:t.offsetWidth+e,height:t.offsetHeight+e}:t;r.MessageDispatcher.dispatch(this.root,{name:"resize",body:n})},t.prototype.reset=function(t,r){void 0===t&&(t=!0),void 0===r&&(r=!0),this.animate(r),n.select(".state",this.root).as(HTMLInputElement).each(function(n){n.checked!=n.defaultChecked&&(n.checked=n.defaultChecked,t&&n.dispatchEvent(e.Events.create("change")))}),this.animate(!0)},t.prototype.animate=function(t){t?this.root.classList.remove("disable-animate"):this.root.classList.add("disable-animate")},t.prototype.stateInput=function(t,e){return n.get('input[name="'+t+'"][value="'+e+'"]',this.root)},t.prototype.hasState=function(t,e){return this.stateInput(t,e).checked},t.prototype.set=function(t,n,r){void 0===r&&(r=!0);var o=this.get(t),i=this.stateInput(t,n);return i.checked=!0,r&&i.dispatchEvent(e.Events.create("change")),o},t.prototype.fire=function(t){var r=n.get('input[name="'+t+'"]:checked',this.root);r.dispatchEvent(e.Events.create("change"))},t.prototype.get=function(t){var e=n.get('input[name="'+t+'"]:checked',this.root);return e?e.value:e},t}();return t.Component=o,t}(shared_component,shared_events,shared_selection,shared_messaging);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};recommendation_journey_recommendation_journey=function(t,e,n,r,o,i,s){var a=function(t){function r(e){t.call(this,".recommendation-journey",e)}return __extends(r,t),r.prototype.render=function(t){var r=o.get(".recommendations",this.root),a=o.get("template",r);t.forEach(function(c,u){var h=u+1,l=i.Templates.clone(a),p="-"+h;new e.RecommendationRenderer(l).render(c);var d={"data-recommendation-doi":c.doi,"data-recommendation-position":String(h),"data-total-recommendations":String(t.length),"data-randomised-recommendation":String(c.randomised),"data-recommendation-link":c.raw_link},f=o.get(".title",l),m=new n.StructuredText;m.process(f),o.select("input[name=recommendation-position]",l).on("change",function(t){m.process(f)}).map(s.attributes(d,{value:String(h),id:function(t){return t+p},checked:1==h}));var y=o.get("label[for=uptodate-recommendation-position].debug",l);if(y.htmlFor+=p,o.select(".text",y).text(String(h)),o.get(".current-recommendation",l).textContent=String(h),o.get(".total-recommendations",l).textContent=String(t.length),o.select("label[for=uptodate-recommendation-position].next",l).map(s.attributes(d,{for:function(e){return e+"-"+(h==t.length?1:h+1)}})),u>0){var v=o.get("label[for=uptodate-recommendation-position].previous",l);v.htmlFor+="-"+u}r.appendChild(l)})},r.prototype.display=function(t){this.position(this.position(),t)},r.prototype.position=function(t,e){return t?Number(this.set("recommendation-position",String(t),e)):Number(this.get("recommendation-position"))},r}(r.Component);return t.RecommendationJourney=a,t}(recommendation_journey_recommendation_journey,recommendation_recommendation,text_text,shared_component,shared_selection,shared_templates,shared_html),minimised_minimised=function(t,e,n){var r=function(){function t(t){this.parent=t,this.element=e.get(".minimised",t)}return t.prototype.initial=function(t){void 0===t&&(t=!0),this.check("minimised-state","initial",t)},t.prototype.notification=function(t){void 0===t&&(t=!0),this.check("minimised-state","notification",t)},t.prototype.check=function(t,r,o){void 0===o&&(o=!0);var i=e.get("input[name="+t+"][value="+r+"]",this.element);i.checked=!0,o&&i.dispatchEvent(n.Events.create("change"))},t}();return t.Minimised=r,t}(minimised_minimised,shared_selection,shared_events),shared_forms=function(t,e){function n(t){var n=e.select("input[name], textarea[name], select[name]",t),r=n.filter(function(t){return!(("radio"==t.type||"checkbox"==t.type)&&!t.checked)}).map(function(t){return encodeURIComponent(t.name)+"="+encodeURIComponent(t.value)}).join("&"),o=(t.getAttribute("method")||"GET").toUpperCase(),i=t.getAttribute("action"),s={},a="";return"GET"==o&&(i=i+"?"+r),"POST"==o&&(s["Content-Type"]="application/x-www-form-urlencoded",a=r),{method:o,url:i,headers:s,entity:a}}return t.request=n,t}(shared_forms,shared_selection);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};email_journey_email=function(t,e,n,r,o,i,s){var a=function(t){function r(e,n){t.call(this,".email",e),this.state=n,this.attachToForm()}return __extends(r,t),r.prototype.attachToForm=function(){var t=this,r=o.get(".card-subscribe",this.root);i.on(r,"submit",function(){r.action=t.state.config.host+"subscribe";var i=o.get("input[name=state]",r);return i.value=JSON.stringify(t.state),t.subscribing(),s.Debug.log("attempting to subscribe"),e.http(n.request(r),function(e){e.status>=299?(s.Debug.log("failed to subscribe"),t.error()):(s.Debug.log("succeeded in subscribing"),t.subscribed())}),!1})},r.prototype.signup=function(){this.set("email-journey","signup")},r.prototype.subscribe=function(){this.set("email-journey","subscribe"),this.set("subscribe-state","initial")},r.prototype.subscribing=function(){this.set("subscribe-state","subscribing")},r.prototype.error=function(){this.set("subscribe-state","error")},r.prototype.subscribed=function(){this.set("email-journey","subscribed")},r}(r.Component);return t.EmailJourney=a,t}(email_journey_email,shared_http,shared_forms,shared_component,shared_selection,shared_html,shared_errors);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};safari_journey_safari=function(t,e,n,r,o){var i=function(t){function n(e,n,r){t.call(this,".safari",e),this.config=n,this.state=r,this.setup()}return __extends(n,t),n.prototype.setup=function(){var t=this;this.config.persist("safari-journey-enabled",null);var e=o.get(".card-enable",this.root);r.attributes({action:function(e){return t.config.data.host+e}})(e),o.select("input[name=return]",e).map(r.attributes({value:this.enableUrl()})),r.on(e,"submit",function(){var n=o.get("input[name=state]",e);return n.value=JSON.stringify(t.state),!0})},n.prototype.enableUrl=function(){var t=this.state.current_location.url,n=e.queryObject(this.state.current_location.url);return n["uptodate-safari-journey-enabled"]=!0,t.split("?")[0]+"?"+e.toQueryString(n)},n.prototype.required=function(){return this.isSafari()&&null==this.user},n.prototype.await=function(t){var e=this;this.currentUser(function(n){e.user=n,t()})},n.prototype.shouldDisplay=function(){return!(!this.hasState("safari-journey","enable")&&!this.hasState("safari-journey","enabled"))||this.isSafari()&&this.user.user_id!=this.config.data.user_id},n.prototype.isSafari=function(){return navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&!navigator.userAgent.match("CriOS")},n.prototype.currentUser=function(t){e.http({method:"GET",url:this.config.data.host+"user/current"},function(e){200==e.status&&t(e.entity.json())})},n.prototype.display=function(){0==this.hasState("safari-journey","enable")&&0==this.hasState("safari-journey","enabled")?this.set("safari-journey","enable"):this.fire("safari-journey")},n}(n.Component);return t.SafariJourney=i,t}(safari_journey_safari,shared_http,shared_component,shared_html,shared_selection),shared_scroll=function(t,e){var n=function(){function t(t){this.config=t}return t.prototype.required=function(){return e.hasVerticalScrollBar()&&!this.hasScrolledEnough()},t.prototype.hasScrolledEnough=function(){return window.pageYOffset>this.config.minimum_scroll_height},t.prototype.await=function(t){var e=this,n=function(){e.hasScrolledEnough()&&(window.removeEventListener("scroll",n),t())};window.addEventListener("scroll",n)},t}();t.WindowScrollCondition=n;var r=function(){function t(t,e,n){var r=this;this.sender=t,this.receiver=e,this.config=n,this.receiver.scroll_info=function(t){return r.scroll_info(t)},this.receiver.scroll_bars_response=function(t){return r.scroll_bars_response(t)},this.sender.send("scroll_bars_request")}return t.prototype.scroll_bars_response=function(t){this.scrollBars=t;
},t.prototype.scroll_info=function(t){if(this.scrollInfo=t,this.done&&this.hasScrolledEnough()){var e=this.done;this.done=null,this.sender.send("scroll_info_stop"),e()}},t.prototype.required=function(){return this.scrollBars&&this.scrollBars.vertical&&!this.hasScrolledEnough()},t.prototype.hasScrolledEnough=function(){return this.scrollInfo&&this.scrollInfo.y>this.config.minimum_scroll_height},t.prototype.await=function(t){this.done=t,this.sender.send("scroll_info_start")},t}();t.ClientScrollListener=r;var o=function(){function t(t,e){var n=this;this.sender=t,this.receiver=e,this.receiver.scroll_info_start=function(){return n.start()},this.receiver.scroll_info_stop=function(){return n.stop()},this.receiver.scroll_bars_request=function(){return n.scroll_bars_request()}}return t.prototype.scroll_bars_request=function(){this.sender.send("scroll_bars_response",{vertical:e.hasVerticalScrollBar(),horizontal:e.hasHorizontalScrollBar()})},t.prototype.start=function(){var t=this;this.handler=window.setInterval(function(){t.sender.send("scroll_info",{x:window.pageXOffset,y:window.pageYOffset})},250)},t.prototype.stop=function(){window.clearInterval(this.handler)},t}();return t.HostScrollListener=o,t}(shared_scroll,shared_html),shared_functions=function(t,e){function n(t,n){return setTimeout(e.UnhandledError.capture(n),t)}function r(t,n){var r=-1;return function(){r!=-1&&clearTimeout(r),r=setTimeout(e.UnhandledError.capture(n),t)}}return t.delay=n,t.idle=r,t}(shared_functions,shared_errors);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};popup_popup=function(t,e,n,r,o,i,s,a,c,u){var h=function(t){function c(s,a,c,u){void 0===u&&(u=new i.WindowScrollCondition(a.config)),t.call(this,".popup",s),this.state=a,this.config=c,this.scroll=u,this.numberOfRecommendations=0,this.minimised=new n.Minimised(this.root),this.recommendationJourney=new e.RecommendationJourney(this.root),this.emailJourney=new r.EmailJourney(this.root,a),this.safariJourney=new o.SafariJourney(this.root,c,a)}return __extends(c,t),c.prototype.render=function(t){this.numberOfRecommendations=t.length,this.recommendationJourney.render(t),this.insertEmailJourney(),this.handleClose()},c.prototype.insertEmailJourney=function(){var t=this;c.allowedEmailSignupHosts.indexOf(this.state.current_location.hostsite)!=-1&&(a.select(".recommendations .next",this.root).on("click",function(e){var n=e,r=Number(n.getAttribute("data-recommendation-position")),o=Math.min(t.numberOfRecommendations,t.state.config.email_journey_position);return o!=r||(t.emailJourney.signup(),t.displayEmailJourney(),!1)}),this.incrementTotal())},c.prototype.incrementTotal=function(){a.select(".total-recommendations",this.root).map(function(t){return t.textContent=String(Number(t.textContent)+1)})},c.prototype.display=function(){var t=this;return this.safariJourney.required()?this.safariJourney.await(function(){t.display()}):this.safariJourney.shouldDisplay()?(this.safariJourney.display(),this.displaySafariJourney(),void this.set("popup","open")):this.scroll.required()?this.scroll.await(function(){return t.display()}):void(0!=this.numberOfRecommendations&&(this.state.config.minimised?(this.fireResize({width:100,height:100}),this.minimise(),this.minimised.notification()):this.open()))},c.prototype.handleClose=function(){var t=this;a.select(".cancel, .no-thanks",this.root).on("click",function(){return t.recommendationJourney.reset(!0,!1),t.displayRecommendationsJourney(),s.delay(1e3,function(){t.emailJourney.reset(!1,!1)}),t.fireResize(a.get(".recommendation-journey",t.root)),!1}),a.select(".maximise",this.root).on("click",function(){return t.config.data.minimised=!1,t.config.persist("minimised","false"),t.minimised.initial(),t.open(),!1}),a.select(".close[for=uptodate-popup-minimised]",this.root).on("click",function(){return t.config.data.minimised=!0,t.config.persist("minimised","true"),t.minimise(),!0}),a.select(".minimised, .journeys",this.root).on(["transitionend","webkitTransitionEnd"],function(e,n){if("visibility"==n.propertyName){u.Debug.log(n);var r=a.get("input[name=popup]:checked",t.root);switch(u.Debug.log(r.value),r.value){case"minimised":var o=a.get("input[name=minimised-state]:checked",t.root);"notification"!=o.value&&t.fireResize({width:80,height:80});break;case"closed":t.fireResize({width:0,height:0})}}}),a.select(".minimised",this.root).on(["animationend","webkitAnimationEnd"],function(e,n){"uptodate-sonar"==n.animationName&&(u.Debug.log(n),t.fireResize({width:80,height:80}))})},c.prototype.open=function(){this.hasState("journey","recommendation")?this.recommendationJourney.display():(this.displayRecommendationsJourney(),this.recommendationJourney.position(1)),this.fireResize(a.get(".recommendation-journey",this.root)),this.set("popup","open")},c.prototype.close=function(){this.set("popup","close")},c.prototype.minimise=function(){this.set("popup","minimised")},c.prototype.displayRecommendationsJourney=function(){this.set("journey","recommendation")},c.prototype.displayEmailJourney=function(){this.fireResize(a.get(".email",this.root)),this.set("journey","email")},c.prototype.displaySafariJourney=function(){this.fireResize(a.get(".safari",this.root)),this.set("journey","safari")},c.allowedEmailSignupHosts=["nature","localhost"],c}(c.Component);return t.Popup=h,t}(popup_popup,recommendation_journey_recommendation_journey,minimised_minimised,email_journey_email,safari_journey_safari,shared_scroll,shared_functions,shared_selection,shared_component,shared_errors),application_application=function(t,e,n,r,o,i,s,a,c,u,h){var l=function(){function t(t,e,n,r){var o=this;void 0===e&&(e=null),void 0===n&&(n=new a.Events(t)),void 0===r&&(r=new i.WindowScrollCondition(t.config)),this.state=t,this.recommendations=e,this.events=n,this.scroll=r;try{this.setup()}catch(t){this.handle(t)}h.UnhandledError.unhandled=function(t){return o.handle(t)}}return t.prototype.handle=function(t){if(this.state.config.debug)throw t;this.events.fire("client","throws","error",{name:t.name,message:t.message,stack:t.stack?t.stack:""})},t.prototype.setup=function(){var t=this,e=c.get("#uptodate",document);if(!e)return this.loadAssets(function(){return t.setup()});var n=c.get(".application",e);n.application=this,this.config=new o.Config(this.state,n),this.state.config=this.config.data,this.popup=new r.Popup(n,this.state,this.config,this.scroll),new s.StateChange(n,this.events),this.display()},t.prototype.loadAssets=function(r){e.http(n.Requests.get(this.state.config.host+t.assets),function(t){if(200==t.status){var e=t.entity.html(),n=c.get("#uptodate",e);u.Templates.polyfillTemplates(n),document.body.appendChild(n),r()}})},t.prototype.display=function(){var t=this;return null==this.recommendations?this.loadRecommendations(function(){return t.display()}):(this.popup.render(this.recommendations),void this.popup.display())},t.prototype.loadRecommendations=function(t){var r=this;e.http(n.Requests.recommendations(this.state),function(e){200==e.status&&(r.recommendations=e.entity.json(),t())})},t.assets="application/application.html",t}();return t.Application=l,t}(application_application,shared_http,shared_requests,popup_popup,config_config,shared_scroll,shared_state,shared_events,shared_selection,shared_templates,shared_errors);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};iframe_host=function(t,e,n,r,o){function i(t){var e=document.createElement("iframe");return e.style.width="0",e.style.height="0",e.style.position="fixed",e.style.bottom="0",e.style.right="0",e.style.zIndex="100000",e.frameBorder="0",e.scrolling="no",e.src=t,e.name="uptodate-client",e.setAttribute("allowtransparency","true"),document.body.appendChild(e),e}var s=function(t){function s(s,a,c){var u=r.BaseUrl.origin(s);t.call(this,window,u),o.Debug.log("Host expecting to send and receive messages from "+u),this.state=c,this.style={width:0,height:0},this.iframe=i(""+s+a+"?source="+r.BaseUrl.origin(window.location.href)),this.iframe.id="uptodate-client",this.iframe.name="uptodate-client",this.sender=new n.MessageSender(this.iframe.contentWindow,u),new e.HostScrollListener(this.sender,this)}return __extends(s,t),s.prototype.state_request=function(){this.sender.send("state_response",this.state)},s.prototype.resize=function(t){this.fullScreen?this.style=t:(this.iframe.style.width=t.width+"px",this.iframe.style.height=t.height+"px")},s.prototype.full_screen=function(t){t?(this.iframe.style.width="100%",this.iframe.style.height="100%"):(this.iframe.style.width=this.style.width+"px",this.iframe.style.height=this.style.height+"px"),this.fullScreen=t},s}(n.MessageReceiver);return t.Host=s,t}(iframe_host,shared_scroll,shared_messaging,shared_http,shared_errors),entry_point_launcher=function(t,e,n){var r=function(){function t(t,n,r){void 0===r&&(r=new e.Events(t)),this.state=t,this.done=n,this.events=r,this.trackCurrentPage(),this.display()}return t.prototype.trackCurrentPage=function(){"article"==this.state.current_location.type&&this.events.fire("website","displays","article")},t.prototype.display=function(){n.isEmpty(this.state.current_location.type)||this.state.config.show_recommendations&&(window.screen.availWidth<this.state.config.minimum_width||this.done())},t}();return t.Launcher=r,t}(entry_point_launcher,shared_events,shared_strings),entry_point_entry_point=function(t,e,n,r,o,i,s,a,c,u,h){var l=this;try{var p=n.BaseUrl.baseUrl("entry-point.js"),d=new e.CurrentLocation;n.http(r.Requests.config(p,d),function(t){if(200==t.status){var e=t.entity.json();c.copyIntoStorage(n.queryObject(),window.localStorage,i.Config.prefix),e=i.Config.mergeObjects(e,i.Config.extractConfig(c.storageObject(l.storage)));var r=u.state(e,d);new h.Launcher(r,function(){e["iframe-client"]?new s.Host(e.host,"generated/client.html",r):(o.Application.assets="generated/application.html",new o.Application(r))})}})}catch(t){a.UnhandledError.unhandled(t)}return t}(entry_point_entry_point,shared_location,shared_http,shared_requests,application_application,config_config,iframe_host,shared_errors,shared_storage,shared_state,entry_point_launcher);
//# sourceMappingURL=entry-point.js.map
